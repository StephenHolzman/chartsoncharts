<!DOCTYPE html>
<meta charset="utf-8"/>
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>
<script src="/assets/d3/d3.min.js"></script>
<script src="/assets/js/date.js"></script>
<script src="/assets/js/vendor/jquery-1.9.1.min.js"></script>



<div id="container"></div>

<script>

/*
	"get_" functions return some value.
	"calc_" functions set variable values.
	"draw_" functions add elements to the dom.
	"update_" functions are transitions.
	"resize_" functions remove and redraw.
*/


//Starting default Variables
var calc_defaults = function(){
	title = "Need to catch up with the election?"
	subtitle = "Review the 2016 Presidential Primary"


	today = dateIDFormat(new Date());
	month_view = dateIDFormat.parse(today);
	startDate = "new Date(2015,2,1)";

	modes = ["Polling","Debates","Funding","Primaries","Tweets"]
	current_mode = "Polling";

	current_party = "Republicans"
}

//Title Controls
var draw_titles = function(selection,title,subtitle){
	var header = d3.select(selection)
				.append("div")
				.attr("id","header");

	header.append("h1")
				.attr("id","title")
				.attr("class","title-text")
				.text(title);

	header.append("h3")
				.attr("id","subtitle")
				.attr("class","title-text")
				.text(subtitle);
};
var calc_titles = function(){
	var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September", "October", "November", "December"];
	if(current_mode==="Polling"){
		if(month_view != "all"){
			title = current_mode + " - " + monthNames[month_view.getMonth()] + " " + month_view.getFullYear();
			subtitle = current_party;
		}else if(month_view === "all"){
			title = "Polling - All"
			subtitle = current_party;
		};		
	};	
};
var update_titles = function(fadeout,fadein){
	d3.selectAll(".title-text")
		.transition()
		.style("opacity","0")
		.duration(fadeout)

	setTimeout(function(){
		calc_titles();

		d3.select("#title")
		.transition()
		.text(title)
		.style("opacity","1")
		.duration(fadein);

		d3.select("#subtitle")
		.transition()
		.text(subtitle)
		.style("opacity","1")
		.duration(fadein);

	},fadeout);
}
//Mode Controls
var draw_modebar = function(selection,modes){
	var mode_select = d3.select(selection)
						.append("div")
						.attr("id","top_navbar")
						.attr("class","navbar horizontal")
						.append("ul")

	for(mode in modes){

		mode_select.append("li")
			.attr("id",modes[mode])
			.attr("class","active mode")
			.on("click",function(){
				d3.selectAll(".mode")
					.attr("class","active mode");

				d3.select(this)
					.attr("class","active selected mode");

				current_mode = d3.select(this).text();
				update_mode();
				//d3.select(".chart").remove();
				console.log(current_mode);
			})
			.append("a")
			.text(modes[mode])
			
	};

	d3.select("#Polling").attr("class","active selected mode");
};
var update_mode = function(){
	d3.select(".chart").transition()
		.style("opacity",0)
		.duration(500);
	d3.select(".chart").remove();
	setTimeout(function(){
		if(current_mode === "Polling"){
			draw_pollingChart("#container",current_party);
			d3.select(".chart").style("opacity",0);
			d3.select(".chart").transition()
			.style("opacity",1)
			.duration(500);

			d3.selectAll(".partybutton").remove();
			draw_partybars("#container");
			update_titles();


		};
	},500);
	

}
//Time Controls
var get_FirstOfMonth = function(date){

	return new Date(date.getFullYear(), date.getMonth(), 1);
};
var get_LastOfMonth = function(date){

	return new Date(date.getFullYear(), date.getMonth()+1,0);
};
var calc_dateformatters = function(){
	monthNameFormat = d3.time.format("%b '%y");
	dateIDFormat = d3.time.format("%b%y");

}
calc_dateformatters();
var update_month = function(){
	if(current_mode === "Polling"){
		
		calc_xScale();
		calc_xAxis();
		d3.select("#timeAxis").transition()
			.duration(600)
			.call(xAxis);
		console.log(current_party);
		calc_yScale(current_party);
		calc_yAxis(current_party);
		
		d3.select("#pollAxis").transition()
			.duration(600)
			.call(yAxis);

		update_titles(500,500);

	};
};
var draw_datebar = function(selection,startdate,enddate){
	datebar = d3.select(selection)
			.append("div")
			.attr("id","bottom_navbar")
			.attr("class","navbar horizontal")
			.append("ul");

	var viewall = datebar.append("li")
		.attr("id","fullview")
		.attr("class","active")
		.on("click",function(){
			if(month_view != "all"){
				
				d3.select(this).attr("class","selected");

				d3.selectAll(".month-direct")
						.attr("class","month-direct active");

				d3.select("#previous").attr("class","inactive");
				d3.select("#next").attr("class","inactive");
				d3.select("#"+today).attr("class","month-direct active feature-month");

				month_view = "all";

				update_month();

				setTimeout(function(){d3.select("#previous").attr("class","inactive");},100);

				d3.selectAll(".month-direct")
						.attr("class","month-direct active");

				d3.select("#"+today).attr("class","month-direct active feature-month");

			};
		})
		.append("a")
		.text("Overview")

	var previous = datebar.append("li")
					.attr("id","previous")
					.attr("class","active")
					.on("click",function(){
						if(month_view != "all" && month_view  > eval(startDate)){
							console.log(startDate)
							console.log(month_view)
							d3.select("#"+dateIDFormat(month_view))
								.attr("class","month-direct active")
							
							month_view = month_view.previous().month();

							update_month();

							d3.select("#"+dateIDFormat(month_view))
								.attr("class","month-direct selected feature-month");

							d3.select("#next").attr("class","active");

							
						};
						if(monthNameFormat(eval(startDate))===monthNameFormat(month_view)){
								d3.select("#previous").attr("class","inactive");
							}else{
								d3.select("#previous").attr("class","active");
							};
					})
					.append("a")
					.text("Previous")

	for(var month = eval(startDate); dateIDFormat.parse(today).next().month() > month; month = month.next().month()){
		datebar.append("li")
			.attr("id",dateIDFormat(month))
			.attr("class","month-direct active")
			.on("click",function(){
				d3.selectAll(".month-direct")
					.attr("class","month-direct active");

				d3.select(this).attr("class","month-direct selected feature-month");

				d3.select("#fullview").attr("class","active");

				month_view = monthNameFormat.parse(d3.select(this).text());
				update_month();
				if(monthNameFormat(dateIDFormat.parse(today))===monthNameFormat(month_view)){
					d3.select("#next").attr("class","inactive");
				}else{
					d3.select("#next").attr("class","active");
				};
				if(monthNameFormat(eval(startDate))===monthNameFormat(month_view)){
					d3.select("#previous").attr("class","inactive");
				}else{
					d3.select("#previous").attr("class","active");
				};
				update_titles();
			})
			.append("a")
			.text(monthNameFormat(month));
			
	};

	var next = datebar.append("li")
					.attr("id","next")
					.attr("class","inactive")
					.on("click",function(){
						if(month_view != "all" && monthNameFormat(month_view) != "Feb '16"){
							d3.select("#"+dateIDFormat(month_view))
								.attr("class","month-direct active")
							
							
							month_view = month_view.next().month();
							update_month();
							d3.select("#"+dateIDFormat(month_view))
								.attr("class","month-direct selected feature-month");
							d3.select("#previous").attr("class","active");
							
							if(monthNameFormat(new Date())===monthNameFormat(month_view)){
								d3.select("#next").attr("class","inactive");
							}else{
								d3.select("#next").attr("class","active");
							};
							if(monthNameFormat(eval(startDate))===monthNameFormat(month_view)){
								d3.select("#previous").attr("class","inactive");
							}else{
								d3.select("#previous").attr("class","active");
							};
						};
					})
					.append("a")
					.text("Next")
	var tweetHandle = datebar
						.append("li")
						.attr("id","tweetHandle")
						.text("@StephenHolz")
						.on("click", function() { window.open("http://twitter.com/StephenHolz"); });


	d3.select("#"+today).attr("class","month-direct active feature-month selected");
};

//Party Controls
var draw_partybars = function(selection){
	dembutton = d3.select(selection)
			.append("svg")
			.attr("id","Democrats_button")
			.attr("class","partybutton")
			.style("width","40px")
			.style("height",((window.innerHeight-162)/2)+"px")
			.style("position","fixed")
			.style("top","126px")
			.style("left","0px")
			.on("click",function(){
				current_party = "Democrats"

				d3.selectAll(".partybutton").remove();
			
				draw_partybars(selection);
				update_titles();
				update_month();
			});
			


	dembutton.append("g")
			.attr("transform", "translate(25,"+(38+((window.innerHeight-162)/4))+")rotate(-90)")
			.append("text")
			.text("Democrats")
			.style("font-family","Arial")


	repbutton = d3.select(selection)
			.append("svg")
			.attr("id","Republicans_button")
			.attr("class","partybutton")
			.style("width","40px")
			.style("height",((window.innerHeight-162)/2)+"px")
			.style("position","fixed")
			.style("bottom","36px")
			.style("left","0px")
			.on("click",function(){
				current_party = "Republicans"

				d3.selectAll(".partybutton").remove();
				draw_partybars(selection);
				update_titles();
				update_month();

			});

	repbutton.append("g")
			.attr("transform", "translate(25,"+(44+((window.innerHeight-162)/4))+")rotate(-90)")
			.append("text")
			.text("Republicans")
			.style("font-family","Arial")

	d3.select("#"+current_party+"_button")
		.attr("class","partybutton partyselected");

}
//All plot margins and height stuff
var calc_plotDimension = function(){
	margin = {top: 0, left: 85, bottom: 30, right: 60};
	if(window.innerWidth<300){
		width = 300 - margin.right - margin.left;
	}else{
		width = window.innerWidth - margin.right - margin.left;
	};

	if(window.innerHeight<400){
		height = 400 - 192
	}else{
		height = (window.innerHeight - 192);
	};
};

//All xAxis Parameters For Each Mode Are Here
var calc_xScale = function(){
	if(current_mode === "Polling"){
		if(month_view != "all"){
			xScale = d3.time.scale()
					.range([0, width])
					.domain([get_FirstOfMonth(month_view),get_LastOfMonth(month_view)]);
		}else if(month_view === "all"){
			xScale = d3.time.scale()
						.range([0, width])
						.domain([get_FirstOfMonth(eval(startDate)),get_LastOfMonth(new Date())])
		}
		
	}
};
var calc_xAxis = function(){
	if(current_mode === "Polling"){
		if(month_view != "all"){
			xAxis = d3.svg.axis()
						.scale(xScale)
						.orient("bottom")
						.ticks(5)
						.tickFormat(d3.time.format('%d'));	
		}else if(month_view === "all"){
			xAxis = d3.svg.axis()
						.scale(xScale)
						.orient("bottom")
						.ticks(4)
						.tickFormat(function(d){
							if(d.getMonth()!=0){
								return d3.time.format("%B")(d)
							}else{
								return d3.time.format("%Y")(d)
							}
						});
		};
	};
};
var draw_xAxis = function(){
	if(current_mode === "Polling"){
			var timeAxis = chart.append("g")
						.attr("id","timeAxis")
						.attr("class","x axis")
						.attr("transform", "translate(0," + height + ")")
						.call(xAxis);
	};
};

//All yAxis Parameters For Each Mode Are Here
var calc_yScale = function(party){

	if(current_mode === "Polling"){
		if(current_party==="Republicans"){
			ydomain = [0,50]
		}else if(current_party==="Democrats"){
			ydomain = [0,65]
		}
		yScale = d3.scale.linear()
						.range([height,0])
						.domain(ydomain);		
	};	
};
var calc_yAxis = function(party){
	if(current_mode === "Polling"){
		if(current_party === "Republicans"){
			yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.tickValues([0,10,20,30,40])
					.tickFormat(function(d){return d + "%";});	
		}else if(current_party === "Democrats"){
			yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.tickValues([0,10,20,30,40,50,60])
					.tickFormat(function(d){return d + "%";});
		};	
	};		
};
var draw_yAxis = function(){
	if(current_mode === "Polling"){
		pollAxis = chart.append("g")
					.attr("id","pollAxis")
					.attr("class", "y axis")
					.call(yAxis)
	};	
};

//Different chart generators
var draw_pollingChart = function(selection,party){
	calc_plotDimension();
	top = 126;
	chart = d3.select(selection)
					.append("svg")
					.attr("id","poll_chart")
					.attr("class","chart")
					.attr("width","100%")
					.attr("height",
						"100%")
					.style("position","fixed")
					.style("top","126px")
					.style("left",0)
					.append("g")
					.attr("transform","translate(" + margin.left + "," + margin.top + ")");

	calc_xScale();
	calc_xAxis();
	draw_xAxis();

	calc_yScale(party);
	calc_yAxis(party);
	draw_yAxis();

	var resize = function(){
		d3.selectAll(".partybutton").remove()
		draw_partybars(selection);

		calc_plotDimension();
		calc_xScale();
		calc_xAxis();
		calc_yScale(party);
		calc_yAxis(party);
		
		d3.selectAll(".axis").remove();
		draw_xAxis();
		draw_yAxis();
	}
	
	d3.select(window).on("resize",resize);
};

calc_defaults();
draw_titles("#container",title,subtitle);
draw_modebar("#container",modes);
draw_datebar("#container",startDate,today);
draw_pollingChart("#container",current_party);
draw_partybars("#container");
d3.selectAll(".partybutton").remove()
draw_partybars("#container");


setTimeout(function(){
	update_titles(500,500);
},4000)
</script>